<% layout('layouts/boilerplate') -%>

<div class="show-page-wrapper">
  <section class="property-hero-gallery">
    <div class="main-image-frame">
      <img
        src="<%= list.image.url %>"
        alt="<%= list.title %>"
        class="property-main-img"
      />
      <div class="gallery-nav-overlay">
        <a href="/listings" class="back-to-collection">
          <i class="fa-solid fa-arrow-left-long me-2"></i> BACK TO COLLECTION
        </a>
      </div>
    </div>
  </section>

  <div class="container mt-5">
    <div class="row">
      <div class="col-lg-8 pe-lg-5">
        <div class="property-intro-box">
          <div class="d-flex gap-2 mb-3">
            <span class="property-badge-luxury"><%= list.category %></span>
            <% if (list.owner) { %>
            <span class="property-badge-luxury host-badge"
              >HOSTED BY <%= list.owner.username.toUpperCase() %></span
            >
            <% } %>
          </div>

          <h1 class="serif-display-title"><%= list.title %></h1>

          <p class="location-text-large">
            <i class="fa-solid fa-location-dot me-2"></i> <%= list.location %>,
            <%= list.country %>
          </p>
        </div>

        <hr class="luxury-divider" />

        <div class="description-section py-4">
          <h4 class="serif-subtitle">About this residence</h4>
          <p class="property-description-p"><%= list.description %></p>
        </div>

        <hr class="luxury-divider" />

        <div class="reviews-section-minimal py-4">
          <div class="d-flex justify-content-between align-items-baseline mb-4">
            <h4 class="serif-subtitle">Guest Experience</h4>
            <span class="review-count-text"
              ><%= list.reviews.length %> Reviews</span
            >
          </div>

          <% if (list.reviews.length === 0) { %>
          <div class="empty-reviews-box">
            <p class="text-muted italic">
              No reviews yet. Be the first to share your journey.
            </p>
          </div>
          <% } else { %>
          <div class="row g-4">
            <% for (let review of list.reviews) { %>
            <div class="col-md-6">
              <div class="minimal-review-card">
                <div class="d-flex justify-content-between mb-2">
                  <span class="reviewer-name"
                    ><%= review.author?.username || "Guest" %></span
                  >
                  <span class="review-stars-gold">
                    <% for (let i = 0; i < review.rating; i++) { %>★<% } %>
                  </span>
                </div>
                <p class="review-text-content">"<%= review.comment %>"</p>
                <div
                  class="d-flex justify-content-between align-items-center mt-3"
                >
                  <small class="review-date-meta"
                    ><%= review.createdAt.toDateString() %></small
                  >

                  <% if (currUser && review.author &&
                  review.author._id.equals(currUser._id)) { %>
                  <form
                    action="/listings/<%= list._id %>/reviews/<%= review._id %>?_method=DELETE"
                    method="POST"
                  >
                    <button class="text-delete-link">Remove</button>
                  </form>
                  <% } %>
                </div>
              </div>
            </div>
            <% } %>
          </div>
          <% } %> <% if (currUser) { %>
          <div class="review-form-box mt-5 p-4 border shadow-sm">
            <h5 class="serif-subtitle mb-3">Leave a Review</h5>
            <form
              action="/listings/<%= list._id %>/reviews"
              method="POST"
              class="needs-validation"
              novalidate
            >
              <div class="mb-4">
                <label class="form-label small fw-bold mb-3">YOUR RATING</label>
                <div class="luxury-rating-selector">
                  <% for (let i = 1; i <= 5; i++) { %>
                  <input
                    type="radio"
                    name="review[rating]"
                    id="rate<%= i %>"
                    value="<%= i %>"
                    required
                  />
                  <label for="rate<%= i %>"><%= i %></label>
                  <% } %>
                </div>
                <div class="invalid-feedback">
                  Please select a rating before submitting.
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label small fw-bold mb-2"
                  >YOUR COMMENT</label
                >
                <textarea
                  class="form-control minimal-input"
                  name="review[comment]"
                  rows="4"
                  placeholder="How was your stay?"
                  required
                ></textarea>
                <div class="invalid-feedback">
                  Please write a short comment.
                </div>
              </div>

              <button class="gold-button w-100 py-3">SUBMIT REVIEW</button>
            </form>
          </div>
          <% } else { %>
          <div class="login-prompt-box text-center p-4 bg-light mt-4">
            <p class="mb-0">
              Please <a href="/login" class="text-dark fw-bold">Login</a> to
              share your experience.
            </p>
          </div>
          <% } %>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="sticky-booking-card">
          <div class="price-header-luxury">
            <span class="price-val"
              >₹ <%= list.price.toLocaleString("en-IN") %></span
            >
            <span class="price-unit">/ night</span>
          </div>

          <div class="booking-features mt-4">
            <div class="feature-item">
              <i class="fa-solid fa-circle-check gold-text me-2"></i> Luxury
              Experience
            </div>
            <div class="feature-item">
              <i class="fa-solid fa-circle-check gold-text me-2"></i> Verified
              Property
            </div>
            <div class="feature-item">
              <i class="fa-solid fa-circle-check gold-text me-2"></i> Secure
              Booking
            </div>
          </div>

          <a
            href="#"
            class="gold-button w-100 text-center mt-4 text-decoration-none"
            >CHECK AVAILABILITY</a
          >

          <% if (currUser && list.owner && list.owner._id.equals(currUser._id))
          { %>
          <div class="owner-controls mt-4 pt-4 border-top">
            <p class="small text-muted mb-3 italic text-center">
              Hosting Tools
            </p>
            <div class="d-grid gap-2">
              <a
                href="/listings/<%= list._id %>/edit"
                class="btn btn-dark btn-sm rounded-0"
                >EDIT PROPERTY</a
              >
              <form
                method="POST"
                action="/listings/<%= list._id %>?_method=DELETE"
                onsubmit="return confirm('Permanently delete this property?')"
              >
                <button class="btn btn-outline-danger btn-sm rounded-0 w-100">
                  DELETE LISTING
                </button>
              </form>
            </div>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <section class="map-section-luxury mt-5 py-5 border-top bg-light">
    <div class="container">
      <h4 class="serif-subtitle mb-4 text-center">Where you'll be</h4>
      <div class="map-frame-luxury shadow-sm">
        <div id="map"></div>
      </div>
    </div>
  </section>
</div>

<script>
  window.MAP_TOKEN = '<%= mapToken %>';
  <% if (list.geometry && list.geometry.coordinates.length) { %>
    window.coordinates = <%- JSON.stringify(list.geometry.coordinates) %>;
  <% } %>
</script>
<script src="/js/map.js"></script>

<style>
  /* Radio Rating Styling */
  .luxury-rating-selector {
    display: flex;
    gap: 12px;
  }
  .luxury-rating-selector input[type='radio'] {
    display: none;
  }
  .luxury-rating-selector label {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ddd;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
  }
  .luxury-rating-selector label:hover {
    border-color: var(--accent-gold);
  }
  .luxury-rating-selector input[type='radio']:checked + label {
    background: var(--accent-gold);
    border-color: var(--accent-gold);
    color: white;
  }

  /* Additional inline spacing/fixes */
  .property-badge-luxury {
    font-size: 0.65rem;
    letter-spacing: 2px;
    background: #f4f1ea;
    padding: 6px 15px;
    font-weight: 700;
    color: var(--primary-dark);
  }
  .host-badge {
    background: #e8e8e8;
  }
  .price-unit {
    color: #888;
    font-size: 0.9rem;
    margin-left: 5px;
  }
  .gold-text {
    color: var(--accent-gold);
  }
  .map-frame-luxury {
    border: 1px solid #ddd;
    padding: 10px;
    background: white;
  }
  #map {
    height: 450px;
    width: 100%;
  }
</style>
