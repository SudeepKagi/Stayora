<% layout('layouts/boilerplate') -%>

<div class="container py-5" style="max-width: 1100px">
  <!-- Back link -->
  <a href="/listings" class="text-success fw-semibold text-decoration-none">
    ‚Üê Back to all stays
  </a>

  <div class="row g-5 mt-4">
    <!-- IMAGE -->
    <div class="col-md-7">
      <img
        src="<%= list.image.url %>"
        alt="<%= list.title %>"
        class="img-fluid rounded-4 shadow-sm w-100"
        style="max-height: 450px; object-fit: cover"
      />
    </div>

    <!-- DETAILS -->
    <div class="col-md-5">
      <!-- Category -->
      <span class="badge rounded-pill bg-success-subtle text-success mb-2">
        <%= list.category %>
      </span>

      <!-- Owner -->
      <% if (list.owner) { %>
      <span class="badge rounded-pill bg-light text-muted mb-2 ms-2">
        Host: <%= list.owner.username %>
      </span>
      <% } %>

      <h1 class="fw-bold mt-2 mb-2"><%= list.title %></h1>

      <p class="text-muted mb-2">
        üìç <%= list.location %>, <%= list.country %>
      </p>

      <p class="price-tag mb-3">
        ‚Çπ <%= list.price.toLocaleString("en-IN") %>
        <span>/ night</span>
      </p>

      <p class="text-secondary mb-4" style="line-height: 1.7">
        <%= list.description %>
      </p>

      <!-- OWNER ACTIONS -->
      <% if (currUser && list.owner && list.owner._id.equals(currUser._id)) { %>
      <div class="d-flex gap-3">
        <a
          href="/listings/<%= list._id %>/edit"
          class="btn btn-outline-success rounded-pill px-4"
        >
          Edit
        </a>

        <form
          method="POST"
          action="/listings/<%= list._id %>?_method=DELETE"
          onsubmit="return confirm('Are you sure you want to delete this stay?')"
        >
          <button class="btn btn-outline-danger rounded-pill px-4">
            Delete
          </button>
        </form>
      </div>
      <% } %>
    </div>
  </div>
</div>

<hr class="my-5" />

<!-- ================= Leave a Review ================= -->
<% if (currUser) { %>
<section class="mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
      <div
        class="card border-0 shadow-sm rounded-4 p-4"
        style="background: #f7faf7"
      >
        <h5 class="fw-bold text-center mb-1">Leave a Review</h5>
        <p class="text-muted small text-center mb-4">
          Share your experience with this stay
        </p>

        <form
          action="/listings/<%= list._id %>/reviews"
          method="POST"
          class="needs-validation"
          novalidate
        >
          <!-- Rating -->
          <div class="mb-4 text-center">
            <label class="form-label fw-semibold d-block mb-2">Rating</label>

            <div class="d-flex justify-content-center gap-3">
              <% for (let i = 1; i <= 5; i++) { %>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="review[rating]"
                  value="<%= i %>"
                  required
                />
                <label class="form-check-label fw-medium"><%= i %></label>
              </div>
              <% } %>
            </div>

            <div class="invalid-feedback d-block mt-2">
              Please select a rating.
            </div>
          </div>

          <!-- Comment -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Comment</label>
            <textarea
              class="form-control rounded-4"
              name="review[comment]"
              rows="3"
              required
              placeholder="Write your experience here..."
            ></textarea>
            <div class="invalid-feedback">Comment cannot be empty.</div>
          </div>

          <div class="text-center">
            <button class="btn btn-success rounded-pill px-5">
              Submit Review
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<% } else { %>

<div class="row justify-content-center mt-5">
  <div class="col-md-6 text-center">
    <div class="alert alert-light border rounded-4">
      <strong>Want to leave a review?</strong>
      <a href="/login" class="text-success fw-semibold ms-1"> Log in </a>
      to share your experience.
    </div>
  </div>
</div>

<% } %>

<hr class="my-5" />

<!-- ================= REVIEWS ================= -->
<section class="reviews-section mt-5">
  <div class="text-center mb-5">
    <h3 class="fw-bold">Guest Reviews</h3>
    <p class="text-muted">Honest experiences shared by travelers</p>
  </div>

  <% if (list.reviews.length === 0) { %>
  <p class="text-center text-muted">No reviews yet.</p>
  <% } %>

  <div class="row justify-content-center g-4">
    <% for (let review of list.reviews) { %>

    <div class="col-md-6 col-lg-5">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <div class="text-warning mb-2">
            <% for (let i = 0; i < review.rating; i++) { %>‚òÖ<% } %>
          </div>

          <p class="fw-semibold mb-3"><%= review.comment %></p>

          <div class="d-flex justify-content-between">
            <small class="text-muted">
              ‚Äî <%= review.author?.username || "Guest" %>
            </small>
            <small class="text-muted">
              <%= review.createdAt.toDateString() %>
            </small>
          </div>

          <% if (currUser && review.author &&
          review.author._id.equals(currUser._id)) { %>
          <form
            action="/listings/<%= list._id %>/reviews/<%= review._id %>?_method=DELETE"
            method="POST"
            class="text-end mt-3"
          >
            <button class="btn btn-sm btn-outline-danger rounded-pill">
              Delete
            </button>
          </form>
          <% } %>
        </div>
      </div>
    </div>

    <% } %>
  </div>
</section>

<!-- ================= MAP ================= -->
<section class="listing-map-section container my-5">
  <h4 class="mb-2">Location</h4>
  <p class="text-muted mb-3">Where this stay is located</p>

  <div id="map" style="height: 350px; border-radius: 16px"></div>
</section>

<script>
  window.MAP_TOKEN = '<%= mapToken %>';
  <% if (list.geometry && list.geometry.coordinates.length) { %>
    window.coordinates = <%- JSON.stringify(list.geometry.coordinates) %>;
  <% } %>
</script>

<script src="/js/map.js"></script>
